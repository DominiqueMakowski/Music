<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Music Tabs</title>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <div id="top-bar">
            <div style="float: left">
                <button id="back-btn" style="display: none">Back</button>
            </div>
            <div style="float: right">
                <button id="theme-toggle">ðŸŒ™</button>
            </div>
        </div>
        <main id="content-area">
            <div id="toc">
                <h1>Dom's tabs</h1>
                <input id="search" placeholder="Search songs..." />
                <table id="toc-table">
                    <thead>
                        <tr>
                            <th id="sort-artist">Artist <span id="arrow-artist"></span></th>
                            <th id="sort-title">Song <span id="arrow-title"></span></th>
                        </tr>
                    </thead>
                    <tbody id="toc-body"></tbody>
                </table>
            </div>
            <div id="song" style="display: none">
                <div id="tabs"></div>
                <div id="lyrics"></div>
            </div>
        </main>

        <script src="data.js"></script>
        <script>
            const tocDiv = document.getElementById("toc")
            const tocBody = document.getElementById("toc-body")
            const sortArtist = document.getElementById("sort-artist")
            const sortTitle = document.getElementById("sort-title")
            const arrowArtist = document.getElementById("arrow-artist")
            const arrowTitle = document.getElementById("arrow-title")
            const songDiv = document.getElementById("song")
            const tabsDiv = document.getElementById("tabs")
            const lyricsDiv = document.getElementById("lyrics")
            const searchInput = document.getElementById("search")
            const themeToggle = document.getElementById("theme-toggle")
            const backBtn = document.getElementById("back-btn")
            const topBar = document.getElementById("top-bar")

            // Theme toggle
            themeToggle.addEventListener("click", () => {
                document.body.classList.toggle("light-theme")
                themeToggle.textContent = document.body.classList.contains("light-theme") ? "â˜€ï¸" : "ðŸŒ™"
            })

            // Adjust view to fit content on screen
            function adjustTallView() {
                if (songDiv.style.display === "none") return

                const lyricsEl = lyricsDiv
                const tabsHeight = tabsDiv.getBoundingClientRect().height
                const availableHeight = window.innerHeight - 45 - tabsHeight - 30 // 30px for padding

                // Get text lines
                const h1 = lyricsEl.querySelector("h1")
                const h1Text = h1 ? h1.textContent : ""
                const textContent = lyricsEl.textContent.replace(h1Text, "").trim()
                const lines = textContent.split("\n").filter((line) => line.trim().length > 0)

                // Reset to default
                lyricsEl.style.fontSize = ""
                lyricsEl.style.columnCount = ""

                // Get actual content width (excluding padding)
                const style = getComputedStyle(lyricsEl)
                const paddingLeft = parseFloat(style.paddingLeft)
                const paddingRight = parseFloat(style.paddingRight)
                const contentWidth = lyricsEl.clientWidth - paddingLeft - paddingRight

                // Try different column counts (1 to 4)
                let bestFontSize = 0
                let bestColumns = 1

                for (let cols = 1; cols <= 4; cols++) {
                    lyricsEl.style.columnCount = cols

                    // Calculate available width per column (with safety margin)
                    const columnRule = 1 // 1px column rule
                    const totalGap = (cols - 1) * 30 // 30px gap between columns
                    const totalRuleWidth = (cols - 1) * columnRule
                    const columnWidth = (contentWidth - totalGap - totalRuleWidth) / cols - 5 // 5px safety margin

                    // Binary search for optimal font size
                    let minSize = 8
                    let maxSize = 200
                    let fontSize = minSize

                    // Create a temporary span to measure text width
                    const measureSpan = document.createElement("span")
                    measureSpan.style.visibility = "hidden"
                    measureSpan.style.position = "absolute"
                    measureSpan.style.whiteSpace = "nowrap"
                    measureSpan.style.fontFamily = getComputedStyle(lyricsEl).fontFamily
                    document.body.appendChild(measureSpan)

                    while (maxSize - minSize > 1) {
                        fontSize = Math.floor((minSize + maxSize) / 2)
                        lyricsEl.style.fontSize = fontSize + "px"
                        if (h1) h1.style.fontSize = fontSize * 1.2 + "px"

                        // Measure if ALL lines fit in column width
                        measureSpan.style.fontSize = fontSize + "px"
                        let maxLineWidth = 0
                        for (const line of lines) {
                            measureSpan.textContent = line
                            maxLineWidth = Math.max(maxLineWidth, measureSpan.offsetWidth)
                        }

                        // Check if content fits: no wrapping and within height
                        const fitsWidth = maxLineWidth <= columnWidth
                        const fitsHeight = lyricsEl.scrollHeight <= availableHeight
                        const fits = fitsWidth && fitsHeight

                        if (fits) {
                            minSize = fontSize
                        } else {
                            maxSize = fontSize
                        }
                    }

                    document.body.removeChild(measureSpan)

                    if (minSize > bestFontSize) {
                        bestFontSize = minSize
                        bestColumns = cols
                    }
                }

                lyricsEl.style.columnCount = bestColumns
                lyricsEl.style.fontSize = bestFontSize + "px"
                if (h1) h1.style.fontSize = bestFontSize * 1.2 + "px"
            }

            window.addEventListener("resize", adjustTallView)

            // Back button
            backBtn.addEventListener("click", showToc)

            let currentSort = "artist"
            let sortOrder = 1 // 1 asc, -1 desc
            let sortedData = [...window.DATA]

            function populateTable() {
                tocBody.innerHTML = ""
                sortedData.forEach((song) => {
                    const row = document.createElement("tr")
                    row.innerHTML = `<td>${song.artist}</td><td>${song.title}</td>`
                    row.onclick = () => showSong(song)
                    tocBody.appendChild(row)
                })
            }

            function sortBy(field) {
                if (currentSort === field) {
                    sortOrder = -sortOrder
                } else {
                    currentSort = field
                    sortOrder = 1
                }
                sortedData.sort((a, b) => sortOrder * a[field].localeCompare(b[field]))
                populateTable()
                arrowArtist.textContent = currentSort === "artist" ? (sortOrder === 1 ? "â–²" : "â–¼") : ""
                arrowTitle.textContent = currentSort === "title" ? (sortOrder === 1 ? "â–²" : "â–¼") : ""
            }

            sortArtist.addEventListener("click", () => sortBy("artist"))
            sortTitle.addEventListener("click", () => sortBy("title"))

            // Initialize table
            sortBy("artist")

            // Search functionality
            searchInput.addEventListener("input", () => {
                const query = searchInput.value.toLowerCase()
                const rows = tocBody.querySelectorAll("tr")
                rows.forEach((row) => {
                    const text = row.textContent.toLowerCase()
                    row.style.display = text.includes(query) ? "" : "none"
                })
            })

            function showSong(song) {
                tocDiv.style.display = "none"
                songDiv.style.display = "block"
                backBtn.style.display = "inline"
                tabsDiv.textContent = song.tabs.trim()
                lyricsDiv.innerHTML = `<h1>${song.artist} - ${song.title}</h1>\n${song.lyrics.trim()}`

                // Adjust layout
                setTimeout(adjustTallView, 50)
            }

            function showToc() {
                songDiv.style.display = "none"
                tocDiv.style.display = "block"
                backBtn.style.display = "none"
                searchInput.value = ""
                populateTable()
            }
        </script>
    </body>
</html>
